Create database btviews;
Use btviews;

Create table ctpxuat(
    SOPX int,
    MAVTU int,
    SLXUAT int,
    DGXUAT float,
    Primary key (SOPX),
    Foreign key (MAVTU) references vattu(MAVTU)
);
CREATE TABLE TONKHO(
    NAMTHANG DATE,
    MAVTU INT,
    SLDAU INT,
    TONGSLN INT,
    TONGSLX INT,
    SLCUOI INT,
    PRIMARY KEY (NAMTHANG),
    FOREIGN KEY (MAVTU) REFERENCES VATTU(MAVTU)
);
Create table PXUAT(
    SOPX INT,
    NGAYXUAT DATE,
    TENKH VARCHAR(64),
    PRIMARY KEY(SOPX),
    FOREIGN KEY (SOPX) REFERENCES ctpxuat(SOPX)
);
CREATE TABLE CTDONDH(
    SODH INT,
    MAVTU INT,
    SLDAT INT,
    PRIMARY KEY (SODH),
    FOREIGN KEY (MAVTU) REFERENCES VATTU(MAVTU)
);
CREATE TABLE CTPNHAP(
    SOPN INT,
    MAVTU INT,
    SLNHAP INT,
    DGNHAP FLOAT,
    PRIMARY KEY (SOPN),
    FOREIGN KEY (MAVTU) REFERENCES VATTU(MAVTU)
);
CREATE TABLE VATTU(
    MAVTU INT,
    TENVTU VARCHAR(64),
    DVTINH VARCHAR(64),
    PHATRAM FLOAT,
    PRIMARY KEY (MAVTU)
);
CREATE TABLE PNHAP(
    SOPN INT,
    NGAYNHAP DATE,
    SODH INT,
    PRIMARY KEY (SOPN),
    FOREIGN KEY (SOPN) REFERENCES CTPNHAP(SOPN),
	Foreign key (SODH) references dondh(SODH)
);
CREATE TABLE NHACC(
    MANHACC INT,
    TENNHACC VARCHAR(255),
    DIACHI VARCHAR(255),
    DIENTHOAI INT,
    PRIMARY KEY (MANHACC)
);
CREATE TABLE DONDH(
    SODH INT,
    NGAYDH DATE,
    MANHACC INT,
    PRIMARY KEY (SODH),
    FOREIGN KEY (MANHACC) REFERENCES NHACC(MANHACC),
    Foreign key (SODH) references ctdondh(SODH)
    );

	CREATE VIEW QLKH.VW_CTPNHAP AS SELECT SOPN,CTPNHAP.MAVTU,SLNHAP,DGNHAP,(SLNHAP*DGNHAP) AS THANHTIENNHAP
	FROM QLKH.CTPNHAP JOIN QLKH.VATTU
	ON CTPNHAP.MAVTU = VATTU.MAVTU;
	
	CREATE VIEW QLKH.VW_CTPNHAP_VT AS SELECT SOPN,VATTU.MAVTU,VATTU.TENVTU,SLNHAP,DGNHAP,(SLNHAP*DGNHAP) AS THANHTIENNHAP
	FROM QLKH.CTPNHAP JOIN QLKH.VATTU
	ON CTPNHAP.MAVTU = VATTU.MAVTU;
	
    CREATE VIEW QLKH.CTPNHAP_VT_PN AS SELECT PNHAP.SOPN,PNHAP.NGAYNHAP,PNHAP.SODH,VATTU.MAVTU,VATTU.TENVTU,CTPNHAP.SLNHAP,CTPNHAP.DGNHAP,(SLNHAP*DGNHAP) AS THANHTIENNHAP
	FROM QLKH.VATTU JOIN QLKH.CTPNHAP
	ON VATTU.MAVTU = CTPNHAP.MAVTU JOIN QLKH.PNHAP
	ON CTPNHAP.SOPN = PNHAP.SOPN;
	
	CREATE VIEW QLKH.CTPNHAP_VT_PN_DH AS SELECT PNHAP.SOPN,PNHAP.NGAYNHAP,MANHACC,PNHAP.SODH,VATTU.MAVTU,VATTU.TENVTU,CTPNHAP.SLNHAP,CTPNHAP.DGNHAP,(SLNHAP*DGNHAP) AS THANHTIENNHAP
	FROM QLKH.VATTU JOIN QLKH.CTPNHAP
	ON VATTU.MAVTU = CTPNHAP.MAVTU JOIN QLKH.PNHAP
	ON CTPNHAP.SOPN = PNHAP.SOPN JOIN QLKH.DONDH
	ON PNHAP.SODH = DONDH.SODH;
	
	CREATE VIEW QLKH.VW_CTPNHAP_LOC AS SELECT SOPN,MAVTU,SLNHAP,DGNHAP,(SLNHAP*DGNHAP)AS THANHTIENNHAP
	FROM QLKH.CTPNHAP WHERE SLNHAP>5;
	
	CREATE VIEW QLKH.VW_CTPNHAP_VT_LOC AS SELECT SOPN,VATTU.MAVTU,VATTU.TENVTU,SLNHAP,DGNHAP,(SLNHAP*DGNHAP) AS THANHTIENNHAP
	FROM QLKH.CTPNHAP JOIN QLKH.VATTU
	ON CTPNHAP.MAVTU = VATTU.MAVTU
	WHERE DVTINH=12;
	
	CREATE VIEW QLKH.VW_CTPXUAT AS SELECT SOPX,MAVTU,SLXUAT,DGXUAT,(SLXUAT*DGXUAT)AS THANHTIENXUAT
	FROM QLKH.CTPXUAT;
	
	CREATE VIEW QLKH.VW_CTPXUAT_VT AS SELECT SOPX,VATTU.MAVTU,VATTU.TENVTU,SLXUAT,DGXUAT,(SLXUAT*DGXUAT)AS THANHTIENXUAT
	FROM QLKH.CTPXUAT JOIN QLKH.VATTU
	ON CTPXUAT.MAVTU = VATTU.MAVTU;
	
	CREATE VIEW QLKH.VW_CTPXUAT_VT_PX AS SELECT PXUAT.SOPX,VATTU.MAVTU,VATTU.TENVTU,TENKH,SLXUAT,DGXUAT,(SLXUAT*DGXUAT)AS THANHTIENXUAT
	FROM QLKH.CTPXUAT JOIN QLKH.VATTU
	ON CTPXUAT.MAVTU = VATTU.MAVTU JOIN QLKH.PXUAT
	ON CTPXUAT.SOPX = PXUAT.SOPX;


	CREATE PROCEDURE QLKH.TONG_SO_LUONG_CUOI(IN MAVTU_NHAP INT)
	BEGIN
	    SELECT SUM(SLCUOI)
	        FROM QLKH.TONKHO
	            WHERE MAVTU=MAVTU_NHAP;
	END;
	
	CREATE PROCEDURE QLKH.TONG_TIEN_XUAT(IN MAVTU_NHAP INT)
	BEGIN
	    SELECT SUM(SLXUAT*DGXUAT)
	        FROM QLKH.CTPXUAT
	            WHERE MAVTU=MAVTU_NHAP
	    GROUP BY MAVTU;
	END;

	CREATE PROCEDURE QLKH.TONG_SO_LUONG_DAT(IN SODH_NHAP INT)
	BEGIN
	    SELECT SUM(SLDAT)
	    FROM QLKH.CTDONDH
	        WHERE SODH_NHAP=SODH;
	END;
	
	CREATE PROCEDURE QLKH.THEM_DON_DAT_HANG(SODH_NHAP INT,NGAYDH_NHAP DATETIME,MANHACC_NHAP INT)
	BEGIN
	    INSERT INTO QLKH.DONDH VALUE(SODH_NHAP, NGAYDH_NHAP, MANHACC_NHAP)
	END;

	CREATE PROCEDURE QLKH.THEM_CHI_TIET_DON_HANG(SODH_NHAP INT,MAVTU_NHAP INT,SLDAT_NHAP INT)
	BEGIN
	    INSERT INTO QLKH.CTDONDH VALUES (SODH_NHAP,MAVTU_NHAP,SLDAT_NHAP);
	END;
